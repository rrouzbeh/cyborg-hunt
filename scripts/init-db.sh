#!/bin/bash
set -e

clickhouse client -n <<-EOSQL
	CREATE DATABASE IF NOT EXISTS cyborg;
	CREATE TABLE IF NOT EXISTS cyborg.sysmon (date Date DEFAULT toDate(event_date_creation), event_date_creation DateTime, host_name String DEFAULT '',  process_name String DEFAULT '', process_path String DEFAULT '', process_id String DEFAULT '', process_guid String DEFAULT '', process_current_directory String DEFAULT '', process_parent_name String DEFAULT '', process_integrity_level String DEFAULT '', process_parent_command_line String DEFAULT '', process_parent_path String DEFAULT '', process_parent_guid String DEFAULT '', process_command_line String DEFAULT '', src_port String DEFAULT '', src_ip_addr String DEFAULT '', src_ip_public String DEFAULT '', src_ip_type String DEFAULT '', src_ip_rfc String DEFAULT '', src_is_ipv6 String DEFAULT '', src_host_name String DEFAULT '', src_port_name String DEFAULT '', src_ip_version String DEFAULT '', ipv6_src_addr String DEFAULT '', dst_ip_addr String DEFAULT '', dst_ip_type String DEFAULT '', dst_ip_public String DEFAULT '', dst_ip_rfc String DEFAULT '', dst_ip_version String DEFAULT '', dst_host_name String DEFAULT '', dst_port String DEFAULT '', dst_port_name String DEFAULT '', dst_asn UInt32 DEFAULT 0, dst_asn_org String DEFAULT '',  dst_country String DEFAULT '', dst_is_ipv6 String DEFAULT '', ipv6_dst_addr String DEFAULT '', dns_query_name String DEFAULT '', dns_query_status String DEFAULT '', dns_query_results String DEFAULT '', fingerprint_process_command_line_mm3 UInt64 DEFAULT 0, meta_process_command_line_has_non_ascii String DEFAULT '', meta_process_command_line_length UInt64 DEFAULT 0, meta_user_name_is_machine String DEFAULT '', network_protocol String DEFAULT '',  user_account String DEFAULT '', action String DEFAULT '', provider_guid String DEFAULT '', user_session_id String DEFAULT '', registry_key_value String DEFAULT '', event_type String DEFAULT '', hash_sha256 String DEFAULT '',  event_id UInt32 DEFAULT 0, user_reporter_type String DEFAULT '', registry_key_path String DEFAULT '', tag String DEFAULT '', sysmon_version String DEFAULT '', file_name String DEFAULT '', source_name String DEFAULT '', file_product String DEFAULT '', type String DEFAULT '', fingerprint_network_community_id String DEFAULT '', thread_id String DEFAULT '', file_description String DEFAULT '', user_name String DEFAULT '', level String DEFAULT '', network_initiated String DEFAULT '', meta_user_reporter_name_is_machine String DEFAULT '', log_ingest_timestamp String DEFAULT '', user_reporter_name String DEFAULT '', hash String DEFAULT '', service_state String DEFAULT '',  file_version String DEFAULT '', record_number String DEFAULT '', version UInt64 DEFAULT 0, user_reporter_domain String DEFAULT '', hash_md5 String DEFAULT '', file_previous_date_creation DateTime  , user_logon_guid String DEFAULT '', file_name_original String DEFAULT '', user_domain String DEFAULT '', user_logon_id String DEFAULT '', sysmon_schema_version String DEFAULT '', file_company String DEFAULT '', task String DEFAULT '', opcode String DEFAULT '', user_reporter_sid String DEFAULT '', file_date_creation DateTime, UUID String DEFAULT generateUUIDv4(), computer_name String DEFAULT '' )ENGINE = MergeTree(date, (date,host_name), 8192); 
	CREATE TABLE IF NOT EXISTS cyborg.conn (date Date DEFAULT toDate(event_date_creation),  event_date_creation DateTime,  src_ip_addr String DEFAULT '',  src_ip_rfc String DEFAULT '',  src_ip_public String DEFAULT '',  src_ip_type String DEFAULT '',  src_ip_version String DEFAULT '',  src_port UInt32 DEFAULT 0,  src_asn_org String DEFAULT '',  src_asn UInt32 DEFAULT 0,  src_country String DEFAULT '',  dst_ip_addr String DEFAULT '',  dst_ip_rfc String DEFAULT '',  dst_ip_public String DEFAULT '',  dst_ip_type String DEFAULT '',  dst_ip_version String DEFAULT '',  dst_port UInt32 DEFAULT 0,  dst_country String DEFAULT '',  dst_asn_org String DEFAULT '',  dst_asn UInt32 DEFAULT 0,  protocol String DEFAULT '',  service_name String DEFAULT '',  duration Float64 DEFAULT 0,  bytes_out UInt64 DEFAULT 0,  bytes_out_ip UInt64 DEFAULT 0,  bytes_in UInt64 DEFAULT 0,  bytes_in_ip UInt64 DEFAULT 0,  bytes_missed UInt64 DEFAULT 0,  packets_in UInt64 DEFAULT 0,  packets_out UInt64 DEFAULT 0,  src_is_local UInt8 DEFAULT 0,  dst_is_local UInt8 DEFAULT 0,  uid String DEFAULT '',  network_community_id String DEFAULT '',  conn_state String DEFAULT '',  conn_state_desc String DEFAULT '',  history String DEFAULT '',  version String DEFAULT '', sensor_node_name String DEFAULT '', sensor_interface String DEFAULT '', UUID String DEFAULT generateUUIDv4() )ENGINE = MergeTree(date,(date, src_ip_addr, dst_ip_addr),8192);   
	CREATE TABLE IF NOT EXISTS cyborg.dns (date Date DEFAULT toDate(event_date_creation), event_date_creation DateTime, src_ip_addr String DEFAULT '', src_ip_type String DEFAULT '', src_ip_rfc String DEFAULT '', src_ip_public String DEFAULT '', src_ip_version String DEFAULT '', src_port UInt32 DEFAULT 0, src_country String DEFAULT '', src_asn_org String DEFAULT '', src_asn UInt32 DEFAULT 0, dst_ip_addr String DEFAULT '', dst_ip_type String DEFAULT '', dst_ip_rfc String DEFAULT '', dst_ip_public String DEFAULT '', dst_ip_version String DEFAULT '', dst_port UInt32 DEFAULT 0, dst_country String DEFAULT '', dst_asn_org String DEFAULT '', dst_asn UInt32 DEFAULT 0, query String DEFAULT '', Answers Array(String) DEFAULT [], protocol String DEFAULT '', QtypeName String DEFAULT '', QclassName String DEFAULT '', Qtype UInt32 DEFAULT 0, Qclass UInt32 DEFAULT 0, RA UInt8 DEFAULT 0, TransID UInt32 DEFAULT 0, RCode UInt32 DEFAULT 0, RTT Float64 DEFAULT 0, Z UInt32 DEFAULT 0, AA UInt8 DEFAULT 0, Rejected UInt8 DEFAULT 0, RD UInt8 DEFAULT 0, TC UInt8 DEFAULT 0, RCodeName String DEFAULT '', UID String DEFAULT '', TTLs Array(Float64) DEFAULT [], network_community_id String DEFAULT '', UUID String DEFAULT generateUUIDv4() )ENGINE = MergeTree(date, (date,src_ip_addr), 8192); 
	CREATE TABLE IF NOT EXISTS cyborg.file (date Date DEFAULT toDate(event_date_creation), event_date_creation DateTime, src_ip_addr String DEFAULT '', src_ip_type String DEFAULT '', src_ip_rfc String DEFAULT '', src_ip_public String DEFAULT '', src_ip_version String DEFAULT '', src_port UInt32 DEFAULT 0, src_country String DEFAULT '', src_asn_org String DEFAULT '', src_asn UInt32 DEFAULT 0, dst_ip_addr String DEFAULT '', dst_ip_type String DEFAULT '', dst_ip_rfc String DEFAULT '', dst_ip_public String DEFAULT '', dst_ip_version String DEFAULT '', dst_port UInt32 DEFAULT 0, dst_country String DEFAULT '', dst_asn_org String DEFAULT '', dst_asn UInt32 DEFAULT 0, filename String DEFAULT '', conn_uids Array(String) DEFAULT [], fuid String DEFAULT '', source String DEFAULT '', depth UInt32 DEFAULT 0, analyzers Array(String) DEFAULT [], mime_type String DEFAULT '', duration Float64 DEFAULT 0, seen_bytes UInt64 DEFAULT 0, missing_bytes UInt64 DEFAULT 0, overflow_bytes UInt64 DEFAULT 0, timedout UInt8 DEFAULT 0, md5 String DEFAULT '', sha1 String DEFAULT '', network_community_id String DEFAULT '', UUID String DEFAULT generateUUIDv4() )ENGINE = MergeTree(date, (date,src_ip_addr), 8192); 
	CREATE TABLE IF NOT EXISTS cyborg.http (date Date DEFAULT toDate(event_date_creation), event_date_creation DateTime, src_ip_addr String DEFAULT '', src_ip_type String DEFAULT '', src_ip_rfc String DEFAULT '', src_ip_public String DEFAULT '', src_ip_version String DEFAULT '', src_port UInt32 DEFAULT 0, src_country String DEFAULT '', src_asn_org String DEFAULT '', src_asn UInt32 DEFAULT 0, dst_ip_addr String DEFAULT '', dst_ip_type String DEFAULT '', dst_ip_rfc String DEFAULT '', dst_ip_public String DEFAULT '', dst_ip_version String DEFAULT '', dst_port UInt32 DEFAULT 0, dst_country String DEFAULT '', dst_asn_org String DEFAULT '', dst_asn UInt32 DEFAULT 0, host String DEFAULT '', bytes_out UInt64 DEFAULT 0, bytes_in UInt64 DEFAULT 0, status_code UInt16 DEFAULT 0, http_referrer String DEFAULT '', http_user_agent String DEFAULT '', http_user_agent_length UInt64 DEFAULT 0, post_body String DEFAULT '', uri_lenght UInt64 DEFAULT 0, uri String DEFAULT '', orig_mime_types Array(String) DEFAULT [], resp_mime_types Array(String) DEFAULT [], resp_fuids Array(String) DEFAULT [], trans_depth UInt32 DEFAULT 0, post_username String DEFAULT '', http_content_type Array(String) DEFAULT [], status_msg String DEFAULT '', resp_filenames Array(String) DEFAULT [], info_code UInt32 DEFAULT 0, orig_fuids Array(String) DEFAULT [], version String DEFAULT '', origin String DEFAULT '', uid String DEFAULT '', tags Array(String) DEFAULT [], username String DEFAULT '', http_method String DEFAULT '', info_msg String DEFAULT '', proxied Array(String) DEFAULT [], network_community_id String DEFAULT '', UUID String DEFAULT generateUUIDv4() )ENGINE = MergeTree(date, (date,host), 8192); 
	CREATE TABLE IF NOT EXISTS cyborg.notice (date Date DEFAULT toDate(event_date_creation), event_date_creation DateTime, src_ip_addr String DEFAULT '', src_ip_type String DEFAULT '', src_ip_rfc String DEFAULT '', src_ip_public String DEFAULT '', src_ip_version String DEFAULT '', src_port UInt32 DEFAULT 0, src_country String DEFAULT '', src_asn_org String DEFAULT '', src_asn UInt32 DEFAULT 0, dst_ip_addr String DEFAULT '', dst_ip_type String DEFAULT '', dst_ip_rfc String DEFAULT '', dst_ip_public String DEFAULT '', dst_ip_version String DEFAULT '', dst_port UInt32 DEFAULT 0, dst_country String DEFAULT '', dst_asn_org String DEFAULT '', dst_asn UInt32 DEFAULT 0, p UInt32 DEFAULT 0, n UInt32 DEFAULT 0, protocol String DEFAULT '', msg String DEFAULT '', fuid String DEFAULT '', sub String DEFAULT '', uid String DEFAULT '', note String DEFAULT '', suppress_for Float64 DEFAULT 0, actions Array(String) DEFAULT [], network_community_id String DEFAULT '', UUID String DEFAULT generateUUIDv4() )ENGINE = MergeTree(date, (date,src_ip_addr), 8192); 
	CREATE TABLE IF NOT EXISTS cyborg.ssl (date Date DEFAULT toDate(event_date_creation), event_date_creation DateTime, src_ip_addr String DEFAULT '', src_ip_type String DEFAULT '', src_ip_rfc String DEFAULT '', src_ip_public String DEFAULT '', src_ip_version String DEFAULT '', src_port UInt32 DEFAULT 0, src_country String DEFAULT '', src_asn_org String DEFAULT '', src_asn UInt32 DEFAULT 0, dst_ip_addr String DEFAULT '', dst_ip_type String DEFAULT '', dst_ip_rfc String DEFAULT '', dst_ip_public String DEFAULT '', dst_ip_version String DEFAULT '', dst_port UInt32 DEFAULT 0, dst_country String DEFAULT '', dst_asn_org String DEFAULT '', dst_asn UInt32 DEFAULT 0, server_name String DEFAULT '', client_subject String DEFAULT '', issuer String DEFAULT '', curve String DEFAULT '', ja3s String DEFAULT '', ja3 String DEFAULT '', client_issuer String DEFAULT '', version String DEFAULT '', tags String DEFAULT '', next_protocol String DEFAULT '', subject String DEFAULT '', cert_chain_fuids Array(String) DEFAULT [], client_cert_chain_fuids Array(String) DEFAULT [], established UInt8 DEFAULT 0, validation_status String DEFAULT '', last_alert String DEFAULT '', cipher String DEFAULT '', resumed UInt8 DEFAULT 0, uid String DEFAULT '', network_community_id String DEFAULT '', UUID String DEFAULT generateUUIDv4() )ENGINE = MergeTree(date, (date,server_name), 8192); 
EOSQL